<table class="table table-bordered">
  <thead>
    <tr>
      <th>商品名</th>
      <th>単価(税込)</th>
      <th>数量</th>
      <th>小計</th>
    </tr>
  </thead>
  <tbody>
    <% @cart_products.each do |cart| %>
    <tr>
      <td><%= cart.product&.name %></td>
      <% tax_price = cart.product.non_taxed_price * 1.1 %>
      <td><%= tax_price.floor.to_s(:delimited) %></td>
      <td>
        <%= form_with model: cart, url: cart_product_path(cart.product.id), method: :patch, local: true do |f| %>
          <%= f.number_field :quantity, in: 1..10, step: 1, style: "width: 60px;" %>
          <%= f.submit '変更', class: "btn btn-primary btn-sm" %>
        <% end %>
      </td>
      <% subtotal = tax_price * cart.quantity %>
      <td><%= subtotal.floor.to_s(:delimited) %></td>
    </tr>
    <% end %>
  </tbody>
</table>

<h3>支払方法    <%= @order.payment_method %></h3>

<%= form_with model: @order, local: true do |f| %>
  <!-- 支払方法 -->
  <%= f.hidden_field :payment_method, :value => @order.payment_method %>
  <!-- 自分の住所に送る -->
  <% if params[:order][:key] == 'other_address' %>
    <h3>お届け先        <span><%= @order_ship.postal_code + @order_ship.address + @order_ship.name %><span></h3>
    <%= f.hidden_field :postal_code, :value => @order_ship.postal_code %>
    <%= f.hidden_field :address, :value => @order_ship.address %>
    <%= f.hidden_field :address_name, :value => @order_ship.name %>
  <!-- 登録済みの住所に送る -->
  <% elsif params[:order][:key] == 'my_address' %>
    <h3>お届け先        <%= current_customer.postal_code + current_customer.address %><br>
    <%= current_customer.last_name + current_customer.first_name %></h3>
    <%= f.hidden_field :postal_code, :value => current_customer.postal_code %>
    <%= f.hidden_field :address, :value => current_customer.address %>
    <%= f.hidden_field :address_name, :value => current_customer.last_name %>
  <!-- 新しい住所に送る -->
  <% else %>
    <h3>お届け先        <%= @ship.postal_code.to_s + @ship.address.to_s + @ship.name.to_s %></h3>
    <%= f.hidden_field :postal_code, :value => @ship.postal_code.to_s %>
    <%= f.hidden_field :address, :value => @ship.address.to_s %>
    <%= f.hidden_field :address_name, :value => @ship.name.to_s %>
  <% end %>
  <!-- カートの商品 -->

  <%= f.submit '購入を確定する' %>

<% end %>
